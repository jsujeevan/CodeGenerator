
-- Get all schema

IF OBJECT_ID('tempdb..#Entity') IS NOT NULL DROP TABLE #Entity

	CREATE TABLE #Entity
		(
			Entity_s											NVARCHAR(MAX)
		)
INSERT
	INTO
	#Entity
SELECT 
	CASE   
      WHEN SUBSTRING(TABLE_NAME,0,CHARINDEX('_',TABLE_NAME,0)) = '' THEN TABLE_NAME   
      ELSE SUBSTRING(TABLE_NAME,0,CHARINDEX('_',TABLE_NAME,0))  
   END AS 'Entity_s'
FROM 
	INFORMATION_SCHEMA.TABLES 
WHERE 
	TABLES.TABLE_CATALOG='Test'
ORDER BY TABLE_NAME


SELECT 
	CONCAT('<entity_group name=""><entity>',Entity.Entity_s,'</entity></entity_group>','')
FROM 
	#Entity Entity
GROUP BY
	Entity.Entity_s
ORDER BY
	Entity.Entity_s

-- Tables
SELECT 
	CONCAT('<table name="',TABLE_NAME ,'" entity_path="DataModel.', 
	CASE   
      WHEN SUBSTRING(TABLE_NAME,0,CHARINDEX('_',TABLE_NAME,0)) = '' THEN TABLE_NAME   
      ELSE SUBSTRING(TABLE_NAME,0,CHARINDEX('_',TABLE_NAME,0))  
	END ,
	'"></table>')
FROM 
	INFORMATION_SCHEMA.TABLES
WHERE
	TABLES.TABLE_CATALOG='Test'
ORDER BY TABLE_NAME

-- Fields

SELECT 
	CONCAT('<column name="',COLUMN_NAME,'"><table>',COLUMNS.TABLE_NAME,'</table><order>',ORDINAL_POSITION,'</order><pk>',

	  CASE WHEN EXISTS (
	  SELECT 1
		FROM 
			INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS C
			JOIN 
				INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS K ON C.TABLE_NAME = K.TABLE_NAME
			AND C.CONSTRAINT_CATALOG = K.CONSTRAINT_CATALOG
			AND C.CONSTRAINT_SCHEMA = K.CONSTRAINT_SCHEMA
			AND C.CONSTRAINT_NAME = K.CONSTRAINT_NAME
		WHERE 
			C.CONSTRAINT_TYPE = 'PRIMARY KEY'
			AND K.COLUMN_NAME = COLUMNS.COLUMN_NAME
			AND K.TABLE_NAME=COLUMNS.TABLE_NAME
	)
       THEN 'true' 
       ELSE 'false'
  END
	,'</pk><type>',DATA_TYPE,'</type><maxLen>',CHARACTER_MAXIMUM_LENGTH,'</maxLen></column>')
FROM 
	INFORMATION_SCHEMA.COLUMNS
WHERE
	COLUMNS.TABLE_CATALOG='Test'
ORDER BY 
	COLUMN_NAME